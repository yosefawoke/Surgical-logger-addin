<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Surgical Logger for iPhone</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- For more information on Fluent UI, visit https://developer.microsoft.com/fluentui -->
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"/>

    <!-- Template styles optimized for iPhone -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 10px;
            margin: 0;
            background-color: #f5f5f5;
            -webkit-text-size-adjust: 100%;
        }
        h1 {
            text-align: center;
            color: #0078d4;
            font-size: 22px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        h2 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* Prevents iOS zoom on focus */
            -webkit-appearance: none; /* Removes default iOS styling */
            appearance: none;
            background-color: #f9f9f9;
        }
        select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23444' d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px;
        }
        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 5px;
            margin-bottom: 5px;
            -webkit-appearance: none; /* Removes default iOS styling */
            appearance: none;
        }
        button:active {
            background-color: #106ebe;
        }
        .secondary-button {
            background-color: #f0f0f0;
            color: #333;
        }
        .secondary-button:active {
            background-color: #e0e0e0;
        }
        .attendant-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .checkbox-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }
        .checkbox-item label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 16px;
        }
        .nav-buttons {
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .progress-bar {
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: #0078d4;
            width: 25%; /* Will be updated via JS */
            transition: width 0.3s ease;
        }
        .success-message {
            text-align: center;
            padding: 20px;
            background-color: #e6f7ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .success-icon {
            font-size: 48px;
            color: #0078d4;
            margin-bottom: 15px;
        }
    </style>
</head>

<body class="ms-font-m ms-Fabric">
    <div id="app">
        <h1>Surgical Logger</h1>
        <div class="progress-bar">
            <div id="progressBar" class="progress-bar-inner"></div>
        </div>
        <div id="main-content">
            <!-- Step 1: Medical ID, Age, Sex -->
            <div id="section1" class="section active">
                <h2>Patient Information</h2>
                <div class="form-group">
                    <label for="medicalId">Medical ID:</label>
                    <input type="text" id="medicalId" name="medicalId" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="age">Age:</label>
                    <input type="text" id="age" name="age" inputmode="numeric" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="sex">Sex:</label>
                    <select id="sex" name="sex">
                        <option value="">Select</option>
                        <option value="M">M</option>
                        <option value="F">F</option>
                    </select>
                </div>
                <div class="nav-buttons">
                    <button id="nextBtn1">Next</button>
                </div>
            </div>

            <!-- Step 2: Diagnosis and Procedure -->
            <div id="section2" class="section">
                <h2>Diagnosis & Procedure</h2>
                <div class="form-group">
                    <label for="diagnosis">Diagnosis:</label>
                    <input type="text" id="diagnosis" name="diagnosis" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="procedure">Procedure:</label>
                    <input type="text" id="procedure" name="procedure" autocomplete="off">
                </div>
                <div class="nav-buttons">
                    <button id="nextBtn2">Next</button>
                    <button id="prevBtn2" class="secondary-button">Back</button>
                </div>
            </div>

            <!-- Step 3: Attendants -->
            <div id="section3" class="section">
                <h2>Attendants</h2>
                <div class="form-group">
                    <label>Select Attendants:</label>
                    <div id="attendantsContainer" class="attendant-container">
                        <!-- Attendants will be added here -->
                    </div>
                </div>
                <div class="nav-buttons">
                    <button id="nextBtn3">Next</button>
                    <button id="prevBtn3" class="secondary-button">Back</button>
                </div>
            </div>

            <!-- Step 4: Surgery Type and Role -->
            <div id="section4" class="section">
                <h2>Surgery Details</h2>
                <div class="form-group">
                    <label for="surgeryType">Surgery Type:</label>
                    <select id="surgeryType" name="surgeryType">
                        <option value="">Select</option>
                        <option value="Elective">Elective</option>
                        <option value="Emergency">Emergency</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="role">Role:</label>
                    <input type="text" id="role" name="role" autocomplete="off">
                </div>
                <div class="nav-buttons">
                    <button id="submitBtn">Submit</button>
                    <button id="prevBtn4" class="secondary-button">Back</button>
                </div>
            </div>

            <!-- Success Message -->
            <div id="success" class="section">
                <div class="success-message">
                    <div class="success-icon">âœ“</div>
                    <h2>Entry Saved!</h2>
                    <p>Your surgical log entry has been successfully saved.</p>
                </div>
                <div class="nav-buttons">
                    <button id="newEntryBtn">Add Another Entry</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // The initialize function must be run each time a new page is loaded
        Office.onReady(function(info) {
            if (info.host === Office.HostType.Excel) {
                // Initialize the application
                initializeApp();
            }
        });

        const attendants = [
            "Dr Aklilu", "Dr Menarg", "Dr Mengist", "Dr Mequanint", "Dr Misganaw",
            "Dr Amare", "Dr Melese", "Dr Samrawit", "Dr Mesenbet", "Dr Abel",
            "Dr Leaynadis", "Dr Solomon", "Dr Sintaye", "Dr Cheru", "Dr Fasil",
            "Dr Meron", "Dr Adane"
        ];

        let currentSection = 1;
        const totalSections = 4;

        function initializeApp() {
            // Add attendants to the form
            const attendantsContainer = document.getElementById('attendantsContainer');
            attendants.forEach((attendant, index) => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'attendant' + index;
                checkbox.name = 'attendants';
                checkbox.value = attendant;
                
                const label = document.createElement('label');
                label.setAttribute('for', 'attendant' + index);
                label.textContent = attendant;
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                attendantsContainer.appendChild(checkboxItem);
            });

            // Check if the headers exist, if not create them
            ensureHeaders();

            // Set up navigation
            setupNavigation();
            
            // Update progress bar
            updateProgressBar();
        }

        function setupNavigation() {
            // Section 1 navigation
            document.getElementById("nextBtn1").addEventListener("click", function() {
                // Validate input
                const medicalId = document.getElementById('medicalId').value.trim();
                const age = document.getElementById('age').value.trim();
                const sex = document.getElementById('sex').value;

                if (!medicalId) {
                    alert('Please enter a Medical ID');
                    return;
                }
                if (!age || isNaN(age)) {
                    alert('Please enter a valid Age (numeric value)');
                    return;
                }
                if (!sex) {
                    alert('Please select Sex');
                    return;
                }

                currentSection = 2;
                showSection(2);
                updateProgressBar();
            });

            // Section 2 navigation
            document.getElementById("prevBtn2").addEventListener("click", function() {
                currentSection = 1;
                showSection(1);
                updateProgressBar();
            });
            document.getElementById("nextBtn2").addEventListener("click", function() {
                // Validate input
                const diagnosis = document.getElementById('diagnosis').value.trim();
                const procedure = document.getElementById('procedure').value.trim();

                if (!diagnosis) {
                    alert('Please enter a Diagnosis');
                    return;
                }
                if (!procedure) {
                    alert('Please enter a Procedure');
                    return;
                }

                currentSection = 3;
                showSection(3);
                updateProgressBar();
            });

            // Section 3 navigation
            document.getElementById("prevBtn3").addEventListener("click", function() {
                currentSection = 2;
                showSection(2);
                updateProgressBar();
            });
            document.getElementById("nextBtn3").addEventListener("click", function() {
                // Validate at least one attendant is selected
                const checkboxes = document.querySelectorAll('input[name="attendants"]:checked');
                if (checkboxes.length === 0) {
                    alert('Please select at least one Attendant');
                    return;
                }

                currentSection = 4;
                showSection(4);
                updateProgressBar();
            });

            // Section 4 navigation
            document.getElementById("prevBtn4").addEventListener("click", function() {
                currentSection = 3;
                showSection(3);
                updateProgressBar();
            });
            document.getElementById("submitBtn").addEventListener("click", function() {
                // Validate input
                const surgeryType = document.getElementById('surgeryType').value;
                const role = document.getElementById('role').value.trim();

                if (!surgeryType) {
                    alert('Please select Surgery Type');
                    return;
                }
                if (!role) {
                    alert('Please enter a Role');
                    return;
                }

                // Save the entry
                saveEntry();
            });

            // New entry button
            document.getElementById("newEntryBtn").addEventListener("click", function() {
                resetForm();
                currentSection = 1;
                showSection(1);
                updateProgressBar();
            });
        }

        function updateProgressBar() {
            const progressPercent = (currentSection / totalSections) * 100;
            document.getElementById('progressBar').style.width = progressPercent + '%';
        }

        function showSection(sectionNumber) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Show the selected section
            document.getElementById('section' + sectionNumber).classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function ensureHeaders() {
            return Excel.run(function(context) {
                const sheet = context.workbook.worksheets.getActiveWorksheet();
                const headers = ["Date", "Medical ID", "Age", "Sex", "Diagnosis", "Procedure", "Attendants", "Elective/Emergency", "Role"];
                
                // Add headers if they don't exist
                const range = sheet.getRange("A1:I1");
                range.load("values");
                
                return context.sync().then(function() {
                    const currentValues = range.values[0];
                    let needsHeaders = false;
                    
                    // Check if headers already exist
                    for (let i = 0; i < headers.length; i++) {
                        if (currentValues[i] !== headers[i]) {
                            needsHeaders = true;
                            break;
                        }
                    }
                    
                    if (needsHeaders) {
                        // Add headers
                        range.values = [headers];
                        range.format.font.bold = true;
                        range.format.fill.color = "#D3D3D3"; // Light gray
                        
                        // Auto-fit columns
                        sheet.getUsedRange().format.autofitColumns();
                    }
                    
                    // Set up page layout
                    sheet.pageLayout.orientation = Excel.PageOrientation.landscape;
                    sheet.pageLayout.fitToPagesTall = false;
                    sheet.pageLayout.fitToPagesWide = 1;
                    
                    // Enable text wrapping for all columns
                    sheet.getRange("A:I").format.wrapText = true;
                });
            }).catch(function(error) {
                console.log("Error: " + error);
            });
        }

        function resetForm() {
            // Reset all form fields
            document.getElementById('medicalId').value = '';
            document.getElementById('age').value = '';
            document.getElementById('sex').value = '';
            document.getElementById('diagnosis').value = '';
            document.getElementById('procedure').value = '';
            document.getElementById('surgeryType').value = '';
            document.getElementById('role').value = '';
            
            // Uncheck all attendants
            const checkboxes = document.querySelectorAll('input[name="attendants"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function saveEntry() {
            Excel.run(function(context) {
                const sheet = context.workbook.worksheets.getActiveWorksheet();
                
                // Find the next empty row
                const range = sheet.getUsedRange();
                range.load("rowCount");
                
                return context.sync().then(function() {
                    const nextRow = range.rowCount + 1;
                    
                    // Get the current date
                    const today = new Date();
                    const dateString = today.toLocaleDateString();
                    
                    // Get form values
                    const medicalId = document.getElementById('medicalId').value.trim();
                    const age = document.getElementById('age').value.trim();
                    const sex = document.getElementById('sex').value;
                    const diagnosis = document.getElementById('diagnosis').value.trim();
                    const procedure = document.getElementById('procedure').value.trim();
                    const surgeryType = document.getElementById('surgeryType').value;
                    const role = document.getElementById('role').value.trim();
                    
                    // Get selected attendants
                    const selectedAttendants = [];
                    const checkboxes = document.querySelectorAll('input[name="attendants"]:checked');
                    checkboxes.forEach(checkbox => {
                        selectedAttendants.push(checkbox.value);
                    });
                    const attendantsString = selectedAttendants.join(", ");
                    
                    // Add the row
                    const newRow = [dateString, medicalId, age, sex, diagnosis, procedure, attendantsString, surgeryType, role];
                    sheet.getRange(`A${nextRow}:I${nextRow}`).values = [newRow];
                    
                    // Format the new row
                    sheet.getRange(`A${nextRow}:I${nextRow}`).format.borders.getItem('EdgeBottom').style = 'Continuous';
                    sheet.getRange(`A${nextRow}:I${nextRow}`).format.borders.getItem('EdgeTop').style = 'Continuous';
                    sheet.getRange(`A${nextRow}:I${nextRow}`).format.borders.getItem('EdgeLeft').style = 'Continuous';
                    sheet.getRange(`A${nextRow}:I${nextRow}`).format.borders.getItem('EdgeRight').style = 'Continuous';
                    sheet.getRange(`A${nextRow}:I${nextRow}`).format.wrapText = true;
                    
                    // Auto-fit layout
                    sheet.getUsedRange().format.autofitColumns();
                    sheet.getUsedRange().format.autofitRows();
                    
                    // Show success message
                    showSection('success');
                });
            }).catch(function(error) {
                console.log("Error: " + error);
                alert("Error saving entry: " + error);
            });
        }
    </script>
</body>
</html>
